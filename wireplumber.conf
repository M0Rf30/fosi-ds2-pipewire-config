# Audiophile-Grade WirePlumber Configuration for Fosi DS2 with CS43131 DAC
# Optimized for high-fidelity audio with pro-audio profile and minimal processing

# Device-level settings and properties
device-settings = {
  rules = [
    {
      matches = [
        {
          # Match device by name using regex pattern
          "device.name" = "~alsa_card.usb-Speed_Dragon_Fosi_Audio_DS2_5000000001-01"
        }
      ]
      apply = {
        # Remove hardcoded card index - let system detect dynamically
        # Pro-audio profile for high-resolution audio (bypasses some ALSA processing)
        "device.profile.name" = "pro-audio"
        # Disable auto profile/port switching for stability
        "api.acp.auto-profile" = false
        "api.acp.auto-port" = false
        # Dynamic sample rate switching
        "audio.rate" = 0
        # Stereo configuration
        "audio.channels" = 2
        "audio.position" = [FL FR]
      }
    }
  ]
}

# Node-level settings and properties
node-settings = {
  rules = [
    {
      matches = [
        {
          # Match output nodes by name using regex
          "node.name" = "~alsa_output.usb-Speed_Dragon_Fosi_Audio_DS2_5000000001-01.*"
        }
      ]
      apply = {
        # Full format support including DSD (CS43131 supports up to DSD256 via DoP)
        "audio.format" = [S16 S24 S24_32 S32 F32 F64 DSD_U8 DSD_U16 DSD_U32]
        # Dynamic sample rate switching
        "audio.rate" = 0
        # Stereo configuration
        "audio.channels" = 2
        "audio.position" = [FL FR]
        # Enable dynamic rate changes
        "node.force-rate" = 0
        "node.lock-rate" = false
        # Keep DAC active (no pause on idle for instant playback)
        "node.pause-on-idle" = false
        # Never suspend (0 = disabled)
        "session.suspend-timeout-seconds" = 0
        # High-quality resampling (4 = good quality, 10 = highest but CPU intensive)
        "resample.quality" = 4
        "resample.disable" = false
        # Audiophile channel mixing settings
        "channelmix.disable" = false
        "channelmix.normalize" = false
        "channelmix.mix-lfe" = false
        "channelmix.upmix" = false
        "channelmix.stereo-widen" = 0.0
        # Monitor channel volumes separately
        "monitor.channel-volumes" = true
        # High-quality shaped dither for bit-depth conversion
        "dither.method" = "shaped5"
        "dither.noise" = 0
        # High priority for preferred device selection
        "priority.driver" = 1000
        "priority.session" = 1000
      }
    }
  ]
}

# Policy configuration for default audio nodes (sets default sink/source)
policy-default-nodes = {
  # Configuration for default audio sink (output device)
  "Audio/Sink" = {
    # Priority list of sink names to use as default, in order of preference
    priority = [
      # Fosi DS2 output node as first priority (highest priority device)
      "alsa_output.usb-Speed_Dragon_Fosi_Audio_DS2_5000000001-01.*"
    ]
  }
}
