# Audiophile-Grade PipeWire Configuration for Fosi DS2 with CS43131 DAC
# Optimized for high-fidelity audio reproduction with minimal signal degradation
context.properties = {
  # Default sample rate for the PipeWire graph (48kHz base for compatibility)
  default.clock.rate = 48000
  # Supported sample rates for dynamic switching (CS43131 supports up to 384kHz)
  default.clock.allowed-rates = [44100 48000 88200 96000 176400 192000 352800 384000]
  # Minimum quantum size (64 frames balances latency vs USB timing stability)
  default.clock.min-quantum = 64
  # Maximum quantum size for high-latency scenarios
  default.clock.max-quantum = 8192
  # Default quantum (512 frames = ~10.67ms at 48kHz - stable for USB audio)
  default.clock.quantum = 512
  # Upper limit for quantum allocation
  default.clock.quantum-limit = 8192
  # Don't force a specific sample rate, allow dynamic switching
  node.force-rate = 0
  # Allow sample rate to change dynamically
  node.lock-rate = false
}

# Node-specific rules for matching and configuring the Fosi DS2
node.rules = [
  # Rule for Fosi DS2 audio output device
  {
    matches = [
      {
        # Match Fosi DS2 by node name pattern using regex
        node.name = "~alsa_output.usb-Speed_Dragon_Fosi_Audio_DS2_5000000001-01.*"
      }
    ]
    actions = {
      update-props = {
        # Full format support including DSD (CS43131 supports DSD up to DSD256)
        audio.format = [S16 S24 S24_32 S32 F32 F64 DSD_U8 DSD_U16 DSD_U32]
        # Dynamic rate switching (0 = adapt to source)
        audio.rate = 0
        # Stereo configuration
        audio.channels = 2
        audio.position = [FL FR]
        # Enable multi-rate support for dynamic sample rate switching
        api.alsa.multi-rate = true
        # Prevent node from pausing when idle (keeps DAC active for instant playback)
        node.pause-on-idle = false
        # Session suspend timeout (0 = never suspend for minimal startup delay)
        session.suspend-timeout-seconds = 0
        # High-quality resampling when needed (4 = default quality)
        resample.quality = 4
        resample.disable = false
        # Use speex resampler for better quality (default in modern PipeWire)
        #resample.window = kaiser
        #resample.param.kaiser.stopband-attenuation = 100.0
        # Disable channel mixing modifications that could degrade stereo imaging
        channelmix.disable = false
        channelmix.normalize = false
        channelmix.mix-lfe = false
        channelmix.upmix = false
        # Maintain channel volumes separately (no summing)
        monitor.channel-volumes = true
        # Shaped dither for transparent bit-depth reduction (shaped5 is best quality)
        dither.method = shaped5
        dither.noise = 0
        # Priority for driver and session (higher = preferred)
        priority.driver = 1000
        priority.session = 1000
      }
    }
  }
]
